<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>FortuneBear</title>

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="포춘베어">
  <meta property="og:description" content="오늘 이건 조심하라곰">
  <meta property="og:image" content="https://fortunebears.netlify.app/assets/favicon.png">
  <meta property="og:url" content="https://fortunebears.netlify.app">

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon -->
  <link rel="icon" href="/assets/favicon.png" type="image/png">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=SUIT:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- 공통 스타일 -->
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <div class="background-glow"></div>

  <div class="app">

    <!-- =====================
         상단 메뉴바
    ====================== -->
    <nav class="menu-bar">
      <a href="index.html" class="menu-item active">포춘베어</a>
      <a href="decide.html" class="menu-item">포춘베어의 결정</a>
    </nav>

    <!-- =====================
         곰 영역
    ====================== -->
    <div class="bear-area">
      <video class="bear-video" src="bear-loop.mp4" autoplay muted loop playsinline></video>
    </div>

    <!-- =====================
         메인 콘텐츠
    ====================== -->
    <div class="content">
      <h1 class="title">포춘베어</h1>

      <p class="subtitle">
        큰일은 모르겠고,<br>
        오늘은 이 정도는 조심하는 게 낫겠다곰..
      </p>

      <div class="usage-indicator">
        <span id="usage-count">0</span> / 7
      </div>

      <button id="btn" class="main-button">
        오늘의 리스크 듣기
      </button>

      <div id="result" class="result-box"></div>

      <div class="limit-info">
        하루 최대 7회 · 자정 초기화
      </div>
    </div>

    <!-- =====================
         후기 영역
    ====================== -->
    <div class="review-section">
      <h2 class="review-title">포춘베어에게 한마디</h2>

      <textarea id="review-input"
        class="review-input"
        placeholder="오늘 포춘베어의 말은 어땠나요?"
        maxlength="80"></textarea>

      <button id="review-btn" class="review-button">
        익명으로 남기기
      </button>

      <ul id="review-list" class="review-list"></ul>
    </div>

    <div class="credit">
      by 남혁
    </div>

  </div>

  <!-- =====================
       Script
  ====================== -->
  <script>
    /* =====================
       하루 7회 제한
    ===================== */
    const btn = document.getElementById('btn');
    const result = document.getElementById('result');
    const usageCountEl = document.getElementById('usage-count');

    const LIMIT = 7;
    const today = new Date().toISOString().slice(0, 10);

    function getUsage() {
      const saved = localStorage.getItem('fortuneBearUsage');
      if (!saved) return { date: today, count: 0 };

      const data = JSON.parse(saved);
      if (data.date !== today) return { date: today, count: 0 };

      return data;
    }

    function saveUsage(data) {
      localStorage.setItem('fortuneBearUsage', JSON.stringify(data));
    }

    let usage = getUsage();
    usageCountEl.textContent = usage.count;

    btn.addEventListener('click', async () => {
      usage = getUsage();

      if (usage.count >= LIMIT) {
        result.textContent = '오늘은 여기까지다곰.\n내일 다시 이야기하자곰.';
        result.classList.add('show');
        return;
      }

      usage.count++;
      saveUsage(usage);
      usageCountEl.textContent = usage.count;

      result.textContent = '포춘베어가 잠깐 생각 중이다곰…';
      result.classList.add('show');

      try {
        const res = await fetch(
          'https://fortune-bear-backend.onrender.com/api/risk',
          { method: 'POST' }
        );
        const data = await res.json();

        result.textContent = data.result;
      } catch {
        result.textContent = '지금은 말을 아끼는 중이다곰.';
      }
    });

    /* =====================
       익명 닉네임
    ===================== */
    function getAnonymousName() {
      const saved = localStorage.getItem('fortuneBearNickname');
      if (saved) return saved;

      const names = [
        '멍한곰', '졸린곰', '오늘도곰',
        '지나가던곰', '생각중인곰',
        '느릿한곰', '조용한곰'
      ];

      const name = names[Math.floor(Math.random() * names.length)];
      localStorage.setItem('fortuneBearNickname', name);
      return name;
    }

    /* =====================
       후기 서버 연동
    ===================== */
    const reviewInput = document.getElementById('review-input');
    const reviewBtn = document.getElementById('review-btn');
    const reviewList = document.getElementById('review-list');

    async function loadReviews() {
      const res = await fetch(
        'https://fortune-bear-backend.onrender.com/api/reviews'
      );
      const data = await res.json();

      reviewList.innerHTML = '';
      if (!data.success) return;

      data.reviews.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${item.nickname}</strong><br>${item.content}`;
        reviewList.appendChild(li);
      });
    }

    reviewBtn.addEventListener('click', async () => {
      const text = reviewInput.value.trim();
      if (!text) return;

      await fetch(
        'https://fortune-bear-backend.onrender.com/api/reviews',
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            nickname: getAnonymousName(),
            content: text,
          }),
        }
      );

      reviewInput.value = '';
      loadReviews();
    });

    loadReviews();
  </script>

</body>

</html>
