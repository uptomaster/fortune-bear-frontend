<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>FortuneBear</title>

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="í¬ì¶˜ë² ì–´">
  <meta property="og:description" content="ì˜¤ëŠ˜ ì´ê±´ ì¡°ì‹¬í•˜ë¼ê³°">
  <meta property="og:image" content="https://fortunebears.netlify.app/assets/favicon.png">
  <meta property="og:url" content="https://fortunebears.netlify.app">

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon -->
  <link rel="icon" href="/assets/favicon.png" type="image/png">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=SUIT:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Style -->
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <div class="background-glow"></div>

  <div class="app">

    <!-- ë©”ë‰´ë°” -->
    <nav class="menu-bar">
      <a href="index.html" class="menu-item active">í¬ì¶˜ë² ì–´</a>
      <a href="decide.html" class="menu-item">í¬ì¶˜ë² ì–´ì˜ ê²°ì •</a>
    </nav>

    <!-- ê³° ì˜ìƒ -->
    <div class="bear-area">
      <video class="bear-video" src="bear-loop.mp4" autoplay muted loop playsinline></video>
    </div>

    <!-- ë©”ì¸ -->
    <div class="content">
      <h1 class="title">í¬ì¶˜ë² ì–´</h1>

      <p class="subtitle">
        í°ì¼ì€ ëª¨ë¥´ê² ê³ ,<br>
        ì˜¤ëŠ˜ì€ ì´ ì •ë„ëŠ” ì¡°ì‹¬í•˜ëŠ” ê²Œ ë‚«ê² ë‹¤ê³°..
      </p>

      <div class="usage-indicator">
        <span id="usage-count">0</span> / 7
      </div>

      <button id="btn" class="main-button">
        ì˜¤ëŠ˜ì˜ ë¦¬ìŠ¤í¬ ë“£ê¸°
      </button>

      <div id="result" class="result-box"></div>

      <div class="limit-info">
        í•˜ë£¨ ìµœëŒ€ 7íšŒ Â· ìì • ì´ˆê¸°í™”
      </div>
    </div>

    <!-- í›„ê¸° -->
    <div class="review-section">
      <h2 class="review-title">í¬ì¶˜ë² ì–´ì—ê²Œ í•œë§ˆë””</h2>

      <textarea id="review-input"
        class="review-input"
        placeholder="ì˜¤ëŠ˜ í¬ì¶˜ë² ì–´ì˜ ë§ì€ ì–´ë• ë‚˜ìš”?"
        maxlength="80"></textarea>

      <button id="review-btn" class="review-button">
        ìµëª…ìœ¼ë¡œ ë‚¨ê¸°ê¸°
      </button>

      <ul id="review-list" class="review-list"></ul>

      <button id="load-more" class="review-button" style="margin-top:10px; display:none;">
        ë” ë³´ê¸°
      </button>
    </div>

    <div class="credit">
      by ë‚¨í˜
    </div>

  </div>

  <!-- Script -->
  <script>
    /* =====================
       í•˜ë£¨ 7íšŒ ì œí•œ
    ===================== */
    const btn = document.getElementById('btn');
    const result = document.getElementById('result');
    const usageCountEl = document.getElementById('usage-count');

    const LIMIT = 7;
    const today = new Date().toISOString().slice(0, 10);

    function getUsage() {
      const saved = localStorage.getItem('fortuneBearUsage');
      if (!saved) return { date: today, count: 0 };

      const data = JSON.parse(saved);
      if (data.date !== today) return { date: today, count: 0 };

      return data;
    }

    function saveUsage(data) {
      localStorage.setItem('fortuneBearUsage', JSON.stringify(data));
    }

    let usage = getUsage();
    usageCountEl.textContent = usage.count;

    btn.addEventListener('click', async () => {
      usage = getUsage();

      if (usage.count >= LIMIT) {
        result.textContent = 'ì˜¤ëŠ˜ì€ ì—¬ê¸°ê¹Œì§€ë‹¤ê³°.\në‚´ì¼ ë‹¤ì‹œ ì´ì•¼ê¸°í•˜ìê³°.';
        result.classList.add('show');
        return;
      }

      usage.count++;
      saveUsage(usage);
      usageCountEl.textContent = usage.count;

      result.textContent = 'í¬ì¶˜ë² ì–´ê°€ ì ê¹ ìƒê° ì¤‘ì´ë‹¤ê³°â€¦';
      result.classList.add('show');

      try {
        const res = await fetch(
          'https://fortune-bear-backend.onrender.com/api/risk',
          { method: 'POST' }
        );
        const data = await res.json();
        result.textContent = data.result;
      } catch {
        result.textContent = 'ì§€ê¸ˆì€ ë§ì„ ì•„ë¼ëŠ” ì¤‘ì´ë‹¤ê³°.';
      }
    });

    /* =====================
       ìµëª… ë‹‰ë„¤ì„
    ===================== */
    function getAnonymousName() {
      const saved = localStorage.getItem('fortuneBearNickname');
      if (saved) return saved;

      const names = [
        'ë©í•œê³°', 'ì¡¸ë¦°ê³°', 'ì˜¤ëŠ˜ë„ê³°',
        'ì§€ë‚˜ê°€ë˜ê³°', 'ìƒê°ì¤‘ì¸ê³°',
        'ëŠë¦¿í•œê³°', 'ì¡°ìš©í•œê³°'
      ];

      const name = names[Math.floor(Math.random() * names.length)];
      localStorage.setItem('fortuneBearNickname', name);
      return name;
    }

    /* =====================
       Toast Message
    ===================== */
    function showToast(message) {
      let toast = document.querySelector('.toast');

      if (!toast) {
        toast = document.createElement('div');
        toast.className = 'toast';
        document.body.appendChild(toast);
      }

      toast.textContent = message;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }

    /* =====================
       í›„ê¸° í˜ì´ì§€ë„¤ì´ì…˜
    ===================== */
    const reviewInput = document.getElementById('review-input');
    const reviewBtn = document.getElementById('review-btn');
    const reviewList = document.getElementById('review-list');
    const loadMoreBtn = document.getElementById('load-more');

    let page = 1;
    const limit = 5;
    let hasMore = true;

    async function loadReviews(reset = false) {
      if (!hasMore && !reset) return;

      if (reset) {
        page = 1;
        hasMore = true;
        reviewList.innerHTML = '';
      }

      const res = await fetch(
        `https://fortune-bear-backend.onrender.com/api/reviews?page=${page}&limit=${limit}`
      );
      const data = await res.json();
      if (!data.success) return;

      data.reviews.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${item.nickname}</strong><br>${item.content}`;
        reviewList.appendChild(li);
      });

      hasMore = data.hasMore;
      loadMoreBtn.style.display = hasMore ? 'block' : 'none';
      page++;
    }

    loadMoreBtn.addEventListener('click', () => loadReviews());

    reviewBtn.addEventListener('click', async () => {
      const text = reviewInput.value.trim();
      if (!text) return;

      await fetch(
        'https://fortune-bear-backend.onrender.com/api/reviews',
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            nickname: getAnonymousName(),
            content: text,
          }),
        }
      );

      reviewInput.value = '';
      showToast('ê³ ë§™ë‹¤ê³° ğŸ»');
      loadReviews(true);
    });

    // ìµœì´ˆ ë¡œë“œ
    loadReviews();
  </script>

</body>

</html>
