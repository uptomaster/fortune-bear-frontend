<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>포춘베어</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="icon" href="/assets/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=SUIT:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css"/>
</head>

<body>

<div class="background-glow"></div>

<div class="app">

  <nav class="menu-bar">
    <a href="index.html" class="menu-item active">포춘베어</a>
    <a href="decide.html" class="menu-item">포춘베어의 결정</a>
  </nav>

  <div class="bear-area">
    <video class="bear-video" src="bear-loop.mp4" autoplay muted loop playsinline></video>
  </div>

  <div class="content">

    <h1 class="title">포춘베어</h1>

    <p class="subtitle">
      큰일은 모르겠고,<br>
      오늘은 이 정도는 조심하는 게 낫겠다곰..<br>
      (좋은 점수가 나오면 멈추라곰... )
    </p>

    <!-- 운 지수 게이지 -->
    <div class="luck-section">
      <div class="luck-gauge">
        <svg width="160" height="160">
          <circle cx="80" cy="80" r="70" class="gauge-bg"/>
          <circle cx="80" cy="80" r="70" class="gauge-bar" id="gauge-bar"/>
        </svg>
        <div class="gauge-center">
          <div id="luck-score" class="luck-score">0</div>
          <div class="luck-label">오늘의 운 지수</div>
        </div>
      </div>
    </div>

    <div class="usage-indicator">
      <span id="usage-count">0</span> / 7
    </div>

    <button id="btn" class="main-button">오늘의 운세 알아보기</button>

    <div id="result" class="result-box"></div>

    <div class="limit-info">하루 최대 7회 · 자정 초기화</div>

  </div>

  <div class="review-section">
    <h2 class="review-title">포춘베어에게 한마디</h2>

    <textarea id="review-input" class="review-input"
      placeholder="오늘 포춘베어의 말은 어땠나요?" maxlength="80"></textarea>

    <button id="review-btn" class="review-button">익명으로 남기기</button>

    <ul id="review-list" class="review-list"></ul>

    <button id="load-more" class="review-button" style="display:none;margin-top:10px">
      더 보기
    </button>
  </div>

  <div class="credit">by 남혁</div>

</div>

<script>
// DOM 요소들
const btn = document.getElementById('btn');
const result = document.getElementById('result');
const usageCountEl = document.getElementById('usage-count');
const gauge = document.getElementById('gauge-bar');
const scoreText = document.getElementById('luck-score');

// 게이지 설정
const R = 70;
const C = 2 * Math.PI * R;
gauge.style.strokeDasharray = C;
gauge.style.strokeDashoffset = C;

let gaugeTimer = null;

// 하루 제한
const LIMIT = 7;
const today = new Date().toISOString().slice(0,10);

function getUsage() {
  const s = localStorage.getItem('fortuneBearUsage');
  if (!s) return { date: today, count: 0 };
  const d = JSON.parse(s);
  if (d.date !== today) return { date: today, count: 0 };
  return d;
}

function saveUsage(d) {
  localStorage.setItem('fortuneBearUsage', JSON.stringify(d));
}

let usage = getUsage();
usageCountEl.textContent = usage.count;

// 게이지 애니메이션
function setLuck(score) {
  if (gaugeTimer) clearInterval(gaugeTimer);

  if (isNaN(score) || score < 0 || score > 100) score = 0;

  scoreText.textContent = '0';

  const offset = C - (score / 100) * C;
  gauge.style.transition = 'stroke-dashoffset 1.2s ease';
  gauge.style.strokeDashoffset = offset;

  let n = 0;
  gaugeTimer = setInterval(() => {
    n++;
    scoreText.textContent = n;
    if (n >= score) {
      clearInterval(gaugeTimer);
      gaugeTimer = null;
    }
  }, 12);
}

document.addEventListener('DOMContentLoaded', () => {

  if (!btn) {
    console.error('버튼(id="btn")을 찾을 수 없습니다!');
    return;
  }

  btn.addEventListener('click', async () => {
    console.log('포춘베어 버튼 클릭됨!');

    usage = getUsage();

    if (usage.count >= LIMIT) {
      result.innerHTML = '<div class="loading-text">오늘은 여기까지다곰.<br>내일 다시 이야기하자곰.</div>';
      result.classList.add('show');
      return;
    }

    usage.count++;
    saveUsage(usage);
    usageCountEl.textContent = usage.count;

    // 로딩 메시지
    result.innerHTML = '<div class="loading-text">포춘베어가 흐름을 읽는 중이다곰…</div>';
    result.classList.remove('show');
    setTimeout(() => result.classList.add('show'), 50);

    try {
      const res = await fetch('https://fortune-bear-backend.onrender.com/api/risk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!res.ok) throw new Error(`서버 응답 오류: ${res.status}`);

      const data = await res.json();
      console.log('API 응답 전체:', data);

      if (!data.success) {
        result.innerHTML = `<div class="error-text">${data.message || '포춘베어가 흐름을 놓쳤다곰.'}</div>`;
        setLuck(0);
        result.classList.add('show');
        return;
      }

      const luckScore = Number(data.luckScore) || 50;
      const todayFlow = data.todayFlow || '무난한 흐름';
      const bearComment = data.bearComment || '곰이 오늘 조용하네곰.\n그냥 쉬엄쉬엄 가보자곰.';
      const smallTip = data.smallTip || '천천히 하루를 보내자곰.\n작은 행복 찾자곰.';

      setLuck(luckScore);

      result.innerHTML = `
        <strong>${todayFlow}</strong>
        <div class="comment-text">
          ${bearComment.split('\n').join('<br>')}
        </div>
        <div class="tip-text">
          ${smallTip.split('\n').join('<br>')}
        </div>
      `;

      // 애니메이션 부드럽게 적용
      result.classList.remove('show');
      setTimeout(() => result.classList.add('show'), 100);

      console.log('결과 화면 표시 완료!');

    } catch (err) {
      console.error('Fetch 에러:', err);
      result.innerHTML = `<div class="error-text">지금은 흐름이 흐릿하다곰.<br>(에러: ${err.message})</div>`;
      setLuck(0);
      result.classList.add('show');
    }
  });

  // 후기 기능
  const reviewInput = document.getElementById('review-input');
  const reviewList = document.getElementById('review-list');
  const loadMoreBtn = document.getElementById('load-more');

  function getAnonymousName() {
    const s = localStorage.getItem('fortuneBearNickname');
    if (s) return s;

    const names = [
      '멍한곰','졸린곰','오늘도곰','지나가던곰',
      '생각중인곰','느릿한곰','조용한곰',
      '하품하는곰','노래하는곰','북극곰'
    ];

    const n = names[Math.floor(Math.random()*names.length)];
    localStorage.setItem('fortuneBearNickname', n);
    return n;
  }

  let page = 1;
  const limit = 5;
  let hasMore = true;

  async function loadReviews(reset = false) {
    if (!hasMore && !reset) return;

    if (reset) {
      page = 1;
      hasMore = true;
      reviewList.innerHTML = '';
    }

    try {
      const res = await fetch(
        `https://fortune-bear-backend.onrender.com/api/reviews?page=${page}&limit=${limit}`
      );
      const data = await res.json();

      if (!data.success) return;

      data.reviews.forEach(r => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${r.nickname}</strong><br>${r.content}`;
        reviewList.appendChild(li);
      });

      hasMore = data.hasMore;
      loadMoreBtn.style.display = hasMore ? 'block' : 'none';
      page++;
    } catch (err) {
      console.error('후기 로드 실패:', err);
    }
  }

  document.getElementById('review-btn')?.addEventListener('click', async () => {
    const text = reviewInput.value.trim();
    if (!text) return;

    try {
      await fetch('https://fortune-bear-backend.onrender.com/api/reviews', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nickname: getAnonymousName(),
          content: text
        })
      });

      reviewInput.value = '';
      loadReviews(true);
    } catch (err) {
      console.error('후기 저장 실패:', err);
    }
  });

  loadMoreBtn?.addEventListener('click', () => loadReviews());
  loadReviews();
});

</script>

</body>
</html>